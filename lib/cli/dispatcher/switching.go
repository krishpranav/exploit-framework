package dispatcher

import (
	"fmt"
	"strings"

	"github.com/krishpranav/exploit-framework/lib/context"
	"github.com/krishpranav/exploit-framework/lib/util/log"
)

// switching server
func (dispatcher Dispatcher) Switching(args []string) {
	if len(args) != 1 {
		log.Error("Arguments error, use `Help Switching` to get more Switchingrmation")
		dispatcher.SwitchingHelp([]string{})
		return
	}

	// handle the hash represent a server
	for _, server := range context.Ctx.Servers {
		if strings.HasPrefix(server.Hash, strings.ToLower(args[0])) {
			// flip server `GroupDispatch` state
			server.GroupDispatch = !server.GroupDispatch
			// flush all clients related to this server
			for _, client := range (*server).GetAllTCPClients() {
				client.GroupDispatch = server.GroupDispatch
				log.Success("[%t->%t] %s", !client.GroupDispatch, client.GroupDispatch, client.FullDesc())
			}
			return
		}
	}

	// handle the hash represent a client
	for _, server := range context.Ctx.Servers {
		for _, client := range (*server).GetAllTCPClients() {
			if strings.HasPrefix(client.Hash, strings.ToLower(args[0])) {
				client.GroupDispatch = !client.GroupDispatch
				log.Success("[%t->%t] %s", !client.GroupDispatch, client.GroupDispatch, client.FullDesc())
				return
			}
		}
	}

	// handle invalid hash
	log.Error("No such node")
}