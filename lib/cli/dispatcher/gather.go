package dispatcher

import (
	"fmt"

	"github.com/krishpranav/exploit-framework/lib/context"
	"github.com/krishpranav/exploit-framework/lib/util/log"
	"github.com/fatih/color"
)

// gather how many session you have
func (dispatcher Dispatcher) Gather(args []string) {
	if len(args) > 1 {
		log.Error("Arguments error, use `Help Gather` to get more information")
		dispatcher.GatherHelp([]string{})
		return
	}

	if len(args) == 0 {
		if context.Ctx.Current == nil && context.Ctx.CurrentTermite == nil {
			log.Error("Interactive session is not set, please use `Jump` command to set the interactive Interact")
			return
		}

		if context.Ctx.Current != nil {
			current := context.Ctx.Current
			current.GatherClientInfo(current.GetHashFormat())
			ReadLineInstance.SetPrompt(color.CyanString(current.GetPrompt()))
			return
		}

		if context.Ctx.CurrentTermite != nil {
			current := context.Ctx.CurrentTermite
			current.GatherClientInfo(current.GetHashFormat())
			ReadLineInstance.SetPrompt(color.CyanString(current.GetPrompt()))
			return
		}
	} else {
		clue := args[0]
		// Client information
		targetClient := context.Ctx.FindTCPClientByHash(clue)
		if targetClient != nil {
			targetClient.GatherClientInfo(targetClient.GetHashFormat())
			ReadLineInstance.SetPrompt(color.CyanString(targetClient.GetPrompt()))
			return
		}

		// Client information
		targetTermiteClient := context.Ctx.FindTermiteClientByHash(clue)
		if targetTermiteClient != nil {
			targetTermiteClient.GatherClientInfo(targetTermiteClient.GetHashFormat())
			ReadLineInstance.SetPrompt(color.CyanString(targetTermiteClient.GetPrompt()))
			return
		}

		// Server information
		targetServer := context.Ctx.FindServerByHash(clue)
		if targetServer != nil {
			for _, client := range targetServer.Clients {
				client.GatherClientInfo(client.GetHashFormat())
			}
			return
		}
		log.Error("No such node")
	}
}

// gather command help function
func (dispatcher Dispatcher) GatherHelp(args []string) {
	fmt.Println("Usage of Gather")
	fmt.Println("\tGather [HASH]")
	fmt.Println("\tHASH\tThe hash of an node, node can be both a server or a client")
}

// gahter description
func (dispatcher Dispatcher) GatherDesc(args []string) {
	fmt.Println("Gather")
	fmt.Println("\tGather information from the current client or the client with hash provided")
}
